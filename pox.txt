<?php
// ================= CONFIG (single file) =================
$host = "localhost";
$user = "root";
$pass = "Act@2022**";
$dbname = "act";
$table = "members"; // <-- change this
$basePhotoPath = "storage/uploads/"; // For picture column
// =======================================================

$conn = new mysqli($host, $user, $pass, $dbname);
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

$sql = "SELECT * FROM `$table`";
$result = $conn->query($sql);

if (!$result) {
    die("Query error: " . $conn->error);
}

if ($result->num_rows === 0) {
    echo "No records found.";
    $conn->close();
    exit;
}

// Build table header dynamically, then add Face/Face Name/Photo
$fields = $result->fetch_fields();

echo "<table border='1' cellpadding='5' cellspacing='0'>";
echo "<tr>";
foreach ($fields as $f) {
    echo "<th>" . htmlspecialchars($f->name) . "</th>";
}
echo "<th>Face</th><th>Face Name</th><th>Photo</th>";
echo "</tr>";

// Output rows
while ($row = $result->fetch_assoc()) {
    $face = "";
    $face_name = "";
    if (!empty($row['room_info'])) {
        $roomInfo = is_string($row['room_info']) ? json_decode($row['room_info'], true) : $row['room_info'];
        if (is_array($roomInfo)) {
            if (!empty($roomInfo['photo'])) {
                // Use exactly as stored in DB (already "storage/faces/...")
                $face = $roomInfo['photo'];
            }
            if (!empty($roomInfo['name'])) {
                $face_name = $roomInfo['name'];
            }
        }
    }

    // Prepare full path for picture column (prepend storage/uploads/)
    $photo = "";
    if (!empty($row['picture'])) {
        $photo = $basePhotoPath . ltrim($row['picture'], '/');
    }

    echo "<tr>";
    // print all original columns
    foreach ($fields as $f) {
        $col = $f->name;
        $val = isset($row[$col]) ? $row[$col] : "";
        echo "<td>" . htmlspecialchars($val) . "</td>";
    }

    // Face (direct DB path + image)
    if ($face !== "") {
        echo "<td><a href='" . htmlspecialchars($face) . "' target='_blank'><img src='" . htmlspecialchars($face) . "' width='50' height='50'></a><br>" . htmlspecialchars($face) . "</td>";
    } else {
        echo "<td>No Face</td>";
    }

    // Face Name
    echo "<td>" . htmlspecialchars($face_name) . "</td>";

    // Photo (prepend uploads/ + image)
    if ($photo !== "") {
        echo "<td><a href='" . htmlspecialchars($photo) . "' target='_blank'><img src='" . htmlspecialchars($photo) . "' width='50' height='50'></a><br>" . htmlspecialchars($photo) . "</td>";
    } else {
        echo "<td>No Photo</td>";
    }

    echo "</tr>";
}

echo "</table>";

$conn->close();
?>
