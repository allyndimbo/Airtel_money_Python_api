<?php
// ================= CONFIG =================
$host = "localhost";
$user = "root";
$pass = "Act@2022**";
$dbname = "act";
$table = "members"; // <-- change this
$basePhotoPath = "storage/uploads/"; // For picture column
// ==========================================

// Enable errors (for debugging)
error_reporting(E_ALL);
ini_set('display_errors', 1);

$conn = new mysqli($host, $user, $pass, $dbname);
if ($conn->connect_error) {
    die("❌ DB Connection failed: " . $conn->connect_error);
}

// Run query
$sql = "SELECT * FROM `$table`";
$result = $conn->query($sql);

if (!$result) {
    die("❌ Query error: " . $conn->error . "<br>SQL: " . $sql);
}

if ($result->num_rows === 0) {
    echo "⚠️ No records found in table `$table`.";
    $conn->close();
    exit;
}

// Build table header dynamically + add Face/Face Name/Photo
$fields = $result->fetch_fields();

echo "<table border='1' cellpadding='5' cellspacing='0'>";
echo "<tr>";
foreach ($fields as $f) {
    echo "<th>" . htmlspecialchars($f->name) . "</th>";
}
echo "<th>Face</th><th>Face Name</th><th>Photo</th>";
echo "</tr>";

while ($row = $result->fetch_assoc()) {
    $face = "";
    $face_name = "";

    // Decode room_info JSON
    if (!empty($row['room_info'])) {
        $roomInfo = json_decode($row['room_info'], true);

        // Debug if JSON fails
        if (json_last_error() !== JSON_ERROR_NONE) {
            echo "<!-- ⚠️ JSON decode error: " . json_last_error_msg() . " -->";
        }

        if (is_array($roomInfo)) {
            $face = !empty($roomInfo['photo']) ? $roomInfo['photo'] : "";
            $face_name = !empty($roomInfo['name']) ? $roomInfo['name'] : "";
        }
    }

    // Build full path for picture (prepend uploads/)
    $photo = "";
    if (!empty($row['picture'])) {
        $photo = $basePhotoPath . ltrim($row['picture'], '/');
    }

    echo "<tr>";

    // Print all DB columns
    foreach ($fields as $f) {
        $col = $f->name;
        $val = isset($row[$col]) ? $row[$col] : "";
        echo "<td>" . htmlspecialchars($val) . "</td>";
    }

    // Face
    if ($face !== "") {
        echo "<td><a href='" . htmlspecialchars($face) . "' target='_blank'>
                <img src='" . htmlspecialchars($face) . "' width='50' height='50'>
              </a><br>" . htmlspecialchars($face) . "</td>";
    } else {
        echo "<td>❌ No Face</td>";
    }

    // Face Name
    echo "<td>" . ($face_name !== "" ? htmlspecialchars($face_name) : "❌ No Name") . "</td>";

    // Photo
    if ($photo !== "") {
        echo "<td><a href='" . htmlspecialchars($photo) . "' target='_blank'>
                <img src='" . htmlspecialchars($photo) . "' width='50' height='50'>
              </a><br>" . htmlspecialchars($photo) . "</td>";
    } else {
        echo "<td>❌ No Photo</td>";
    }

    echo "</tr>";
}

echo "</table>";

$conn->close();
?>
